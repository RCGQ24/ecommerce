<div class="admin-payment-management">
  <div class="header">
    <h2>Gestión de Pagos</h2>
    <p>Administra y gestiona todos los pagos del sistema</p>
  </div>

  <!-- Estado de carga -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Cargando pagos...</p>
    </div>
  </div>

  <!-- Estado de error -->
  <div *ngIf="error && !isLoading" class="error-state">
    <div class="error-message">
      <i class="fas fa-exclamation-triangle"></i>
      <p>{{ error }}</p>
      <button (click)="loadPayments()" class="btn-retry">
        <i class="fas fa-redo"></i> Reintentar
      </button>
    </div>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!isLoading && !error">
    <!-- Filtros -->
    <div class="filters">
      <div class="filter-group">
        <label>Estado:</label>
        <select [(ngModel)]="selectedStatus" (change)="applyFilters()">
          <option value="">Todos los estados</option>
          <option value="completado">Completado</option>
          <option value="fallido">Fallido</option>
          <option value="reembolsado">Reembolsado</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Método de Pago:</label>
        <select [(ngModel)]="selectedMethod" (change)="applyFilters()">
          <option value="">Todos los métodos</option>
          <option value="1">Tarjeta de Crédito</option>
          <option value="2">Tarjeta de Débito</option>
          <option value="3">Pago Móvil</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Fecha del Pago:</label>
        <input type="date" [(ngModel)]="selectedDate" (change)="applyFilters()" class="date-input">
      </div>
      <button class="btn-clear" (click)="clearFilters()">
        <i class="fas fa-times"></i> Limpiar Filtros
      </button>
    </div>

    <!-- Tabla de pagos -->
    <div class="table-container">
      <!-- Mensaje cuando no hay pagos -->
      <div *ngIf="filteredPayments.length === 0" class="no-payments">
        <i class="fas fa-inbox"></i>
        <h3>No hay pagos registrados</h3>
        <p>No se encontraron transacciones en el sistema.</p>
        <button (click)="loadPayments()" class="btn-refresh">
          <i class="fas fa-sync"></i> Actualizar
        </button>
      </div>

      <!-- Tabla con pagos -->
      <table *ngIf="filteredPayments.length > 0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Monto</th>
            <th>Método</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let payment of filteredPayments">
            <td>{{ payment.id }}</td>
            <td>{{ payment.fecha_pago | date:'dd/MM/yyyy HH:mm' }}</td>
            <td>{{ payment.email_usuario }}</td>
            <td class="amount">{{ payment.monto_pago | currency }}</td>
            <td>{{ getPaymentMethodName(payment.id_metodo_pago) }}</td>
            <td>
              <span class="status-badge" [class]="payment.estado_pago">
                {{ payment.estado_pago }}
              </span>
            </td>
            <td class="actions">
              <button class="btn-view" (click)="viewPayment(payment)" title="Ver Detalles">
                <i class="fas fa-eye"></i>
              </button>
              
              <select class="status-select" 
                      [value]="payment.estado_pago"
                      (change)="changePaymentStatus(payment, $event)">
                <option value="completado">Completado</option>
                <option value="fallido">Fallido</option>
                <option value="reembolsado">Reembolsado</option>
              </select>
              
              <button class="btn-refund" 
                      *ngIf="payment.estado_pago === 'completado'"
                      (click)="processRefund(payment)" 
                      title="Reembolsar">
                <i class="fas fa-undo"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal de detalles -->
  <div class="modal" *ngIf="selectedPayment">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Detalles del Pago</h3>
        <button class="close-modal" (click)="closeModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="payment-details">
        <div class="detail-group">
          <label>ID Transacción</label>
          <p>{{selectedPayment.id}}</p>
        </div>
        <div class="detail-group">
          <label>Fecha</label>
          <p>{{selectedPayment.fecha_pago | date:'dd/MM/yyyy HH:mm'}}</p>
        </div>
        <div class="detail-group">
          <label>Monto Total</label>
          <p class="amount">{{selectedPayment.monto_pago | currency}}</p>
        </div>
        <div class="detail-group">
          <label>Método de Pago</label>
          <p>{{getPaymentMethodName(selectedPayment.id_metodo_pago)}}</p>
        </div>
        <div class="detail-group">
          <label>Estado</label>
          <span class="status-badge" [class]="selectedPayment.estado_pago">
            {{selectedPayment.estado_pago | titlecase}}
          </span>
        </div>
        <div class="detail-group">
          <label>Email usuario</label>
          <p>{{selectedPayment.email_usuario}}</p>
        </div>
        <div class="items-section">
          <h4>Productos</h4>
          <div class="items-list">
            <div class="item" *ngFor="let item of selectedPayment.productos">
              <img *ngIf="item.url_imagen || item.image" [src]="item.url_imagen || item.image" alt="{{item.nombre || item.productName}}" width="80" height="80" style="margin-right: 12px; border-radius: 8px; object-fit: cover;" />
              <div class="item-details">
                <p class="item-name">{{item.nombre || item.productName}}</p>
                <p class="item-quantity">Cantidad: {{item.cantidad || item.quantity}}</p>
                <p class="item-price">{{item.precio || item.price | currency}} <span style="font-size:0.95em;color:#888;">c/u</span></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de reembolso -->
  <div class="modal" *ngIf="showRefundModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Procesar Reembolso</h3>
        <button class="close-modal" (click)="closeRefundModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="refund-form">
        <div class="form-group">
          <label>Monto a reembolsar:</label>
          <input type="number" [(ngModel)]="refundAmount" 
                 [max]="selectedPayment?.monto_pago" 
                 [min]="0.01" 
                 step="0.01">
        </div>
        <div class="form-group">
          <label>Motivo:</label>
          <select [(ngModel)]="refundReason">
            <option value="">Seleccionar motivo</option>
            <option value="product_defect">Producto defectuoso</option>
            <option value="wrong_item">Producto incorrecto</option>
            <option value="customer_request">Solicitud del cliente</option>
            <option value="delivery_issue">Problema de entrega</option>
            <option value="other">Otro</option>
          </select>
        </div>
        <div class="form-actions">
          <button class="btn-cancel" (click)="closeRefundModal()">Cancelar</button>
          <button class="btn-confirm" (click)="confirmRefund()" 
                  [disabled]="!refundAmount || !refundReason">
            Procesar Reembolso
          </button>
        </div>
      </div>
    </div>
  </div>
</div> 